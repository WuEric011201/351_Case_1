% this function seperates the operating freqency we want (from 1 to 5) and
% weight the frequency sections with different magnitude
% 
% parameters:
% input: a string representing the name of the sound file 
% order: the number of times the RC circuits are in series (1 by n array)
% rl, cl are 1 by n array of R and C values; n is the number of low pass filters
% rh, ch are 1 by n array of R and C values; n is the number of high pass filters
% order: the times needed to pass the filter
% magnitude: the number of times the filtered results will be amplified (1 by n array)
% type: l: means only passes through low;  (1 by n array)
%       h: means only passes through high
%       x: means passes through low and high
% 
% returned value:
% output: filtered ouput with given frequency
% new_fs: the new sample frequency

function [output,new_fs]  = freqSep(input, rl, cl, rh, ch, order, magnitude, type)

    [input_audio, input_Fs] = audioread(input);

    %  sampling frequency (last parameter) -------  can change here. The higher
    %  the better, but has a limit  --------- ???? find the optimal ?????
    new_fs = 150000; 
    input_audio = prepocess(input_audio, 0.0005, input_Fs, new_fs); % a function written to preprocess the sound

    % initialize the return matrix
    output = zeros(size(input_audio, 1), size(input_audio, 2)); 

    freq = logspace(1,5, 100); 
%     Result of freq response
    H = zeros(size(rl, 2), length(freq)); 

    % j is the number of bands we have
    for j = 1: size(rl, 2)
        
        % time constant
        taul = rl(1, j)* cl(1, j); 
        tauh = rh(1, j)* ch(1, j);
        
        temp = input_audio; 
        
        % coefficients for filter()
        aLow = [1, ((1/new_fs)/taul)-1]; bLow = (1/new_fs)/taul; % low-pass coeff  %??
        aHigh = [1, ((1/new_fs)/tauh)-1]; bHigh = [1, -1]; % high-pass coeff
        
        % filter the temp signal using the method filter_with_order
        temp = filter_with_order(temp, aLow, bLow, aHigh, bHigh, order(j), type(j)); 
     
        temp = magnitude(j) .* temp; % time the magnitude
        output = output + temp;  % sum the result of each filter 

%         Plot individual band
        H(j , : ) = filterFreqRes(  aLow,  bLow, aHigh ,bHigh , order(j), type(j), new_fs, freq, j);
    end

    H = abs(H);
    H1 = sum(magnitude* H, 1); 
    figure; 
    hold on; 
    for k = 1: size(rl, 2)
        plot(freq, 20*log(H(k, : )* magnitude(k)), 'linewidth', 2);
    end
    plot(freq, 20* log(H1), 'linewidth', 2);
    hold off; 
    legend('Filter1', 'Filter2', 'Filter3', 'Filter4', 'Filter5', 'Equalizer','Unity reference')
    set(gca, 'XScale', 'log'); 
         title('Frequency reponse of the five individual bands and the overall response of the Unity Preset');
        xlabel('Frequency (Hz)'); ylabel('Magnitude');

% Plot the equalizer response all together
        equalizerFreqRes(rl, cl, rh, ch, order, magnitude, type, new_fs, logspace(1,5,60));
%         equalizerImpulseRes(rl, cl, rh, ch, order, magnitude, type, 0:1e-5:1e-3);
end